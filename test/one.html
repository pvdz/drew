<script>var module = {};</script>
<script src="../lib/zeparser2/uni.js"></script>
<script src="../lib/zeparser2/tok.js"></script>
<script src="../lib/zeparser2/par.js"></script>

<script src="../src/constants.js"></script>
<script src="../src/macros.js"></script>
<script src="../src/parse.js"></script>
<script src="../src/run.js"></script>
<script>
  function require(path) {
    switch (path) {
      case './../lib/zeparser2/uni.js': return window;
      case './../lib/zeparser2/tok.js': return window;
      case './../lib/zeparser2/par.js': return window;
      case './../src/parse': return parse;
      case './../src/run': return run;
      case './../src/constants': return constants;
      case './../src/macros': return macros;
      default: console.warn('fake require: unknown path (not hardcoded) ['+path+']');
    }
  }
  require.isFake = true; // browser detection hack :)
</script>


<div><button id="go">go</button> <input type="radio" name="mode" value="once"> once <input type="radio" name="mode" value="after" checked> after <input type="radio" name="mode" value="every"> every </div>
<div>Debug: <textarea id="debug" style="float: right; width: 800px; height: 250px;"></textarea></div>
<div>Query: <input id="query" style="width: 600px;"
       value="(({`!`}{`void`})?{`console`}{`.`}{`log`|`warn`|`group`|`groupEnd`|`error`}{PAREN_PAIR}({`&&`}|{`||`}|{`;`}|{`,`})?)=0,1|({`;`}{CURLY_PAIR})=0,1"
       value="(({`!`}{`void`})?{`console`}{`.`}{`log`|`warn`|`group`|`groupEnd`|`error`}{PAREN_PAIR}({`&&`}|{`||`}|{`;`}|{`,`})?)=0,1"
><button id="parse">parse</button></div>
<div>Handler: function(<input id="args" value="a,b,c">){<textarea id="handler" style="width: 400px; height: 200px;">
  document.querySelector('#debug').value += arguments.length+': '+JSON.stringify([].slice.call(arguments, 0))+'\n\n';

  (function(start, stop){
    for (var i=start; i&lt;=stop; ++i) {
      TOKENS.whites[i].value = '';
    }
  })(arguments[0].white, arguments[1].white);


</textarea>}</div>
<div>Input: <textarea id="input" style="width: 400px; height: 250px;">
  function query(){
  // input query: [`b`][`;`]~$$
  // final query: [`b`][`;`]~$$
  // query start..
var group0 = false;
matchedSomething = false;
console.group("root start");
{ // parseAtomMaybe 1 for a white token `[`
// white token 1:0
group0 = checkTokenWhite(symw() && !void console.log("# 1001 start of literal [`b`] at 4 in query to token "+index+":", token()) && value('b'));
} // `]` 1 for a white token

if (group0)
// white token 2:1
group0 = checkTokenWhite(symw() && !void console.log("# 1002 start of literal [`;`] at 9 in query to token "+index+":", token()) && value(';'));

if (group0)
  // dont seek for leading ~, just wait for a non-spacy token
if (console.log("~ seek() past spaces and tabs at all?", matchedSomething, "start=", index),matchedSomething) {
  if (isSpaceTabComment()) {
    console.log("~ skipping spaces and tabs");
    do ++index;
    while (isSpaceTabComment()); // ~
  }
  group0 = !isWhite(); // if current is white now, seek failed
console.log(group0?"~ passed":"~ failed", index);
}

if (group0)
console.log("$$ end of file?", index >= tokens.length),(group0 = (index >= tokens.length)); // $$
(matchedSomething = true);

console.groupEnd();

  // query end..
  return group0;
}
</textarea></div>
<div>Output: <textarea id="output" style="width: 400px; height: 250px;"></textarea></div>


<script>
  document.querySelector('#parse').onclick = function() {
    var rule = document.querySelector('#query').value;
    var funcCode = parse(rule, constants, macros);
    document.querySelector('#debug').value = funcCode;
  };
  document.querySelector('#go').onclick = function() {
    document.querySelector('#debug').value = '';
    var rule = document.querySelector('#query').value;
    var mode = document.querySelector('[name="mode"]:checked').value;
    var input = document.querySelector('#input').value;
    var handler = Function.apply(Function, document.querySelector('#args').value.split(',').concat([document.querySelector('#handler').value]));

    console.log('Target query:', [rule]);
    console.log('Target input:', [input]);
    console.log(handler);

    var funcCode = parse(rule, constants, macros);
    window.TOKENS = Par.parse(input, {saveTokens: true});
    console.log(funcCode);
    console.log(TOKENS);

    run(TOKENS.whites, funcCode, handler, mode);

    document.querySelector('#output').value = TOKENS.whites.map(function (t) {
      return t.value;
    }).join('');
  };

</script>