<!-- take heed. this document is soup. and dun caaaaare. tralaalalalalaaaaa :) -->

<script>var module = {};</script>
<script src="../lib/zeparser2/uni.js"></script>
<script src="../lib/zeparser2/tok.js"></script>
<script src="../lib/zeparser2/par.js"></script>

<script src="../lib/splitter.js"></script>

<script src="../src/constants.js"></script>
<script src="../src/macros.js"></script>
<script src="../src/parse.js"></script>
<script src="../src/run.js"></script>
<script src="console_examples.js"></script>
<script>
  function require(path) {
    switch (path) {
      case './../lib/zeparser2/uni.js':
        return window;
      case './../lib/zeparser2/tok.js':
        return window;
      case './../lib/zeparser2/par.js':
        return window;
      case './../src/parse':
        return parse;
      case './../src/run':
        return run;
      case './../src/constants':
        return constants;
      case './../src/macros':
        return macros;
      default:
        console.warn('fake require: unknown path (not hardcoded) [' + path + ']');
    }
  }
  require.isFake = true; // browser detection hack :)
</script>

<style>
  body { margin: 0; padding: 0; }
  #top { position: relative; overflow: auto; width: 100%; box-sizing: border-box; padding: 10px 0 0 10px; margin-right: 0; }
  #main { position: relative; width: 99%; height: calc(100% - 150px); margin: 10px; padding: 0; }
  #main > div { float: left; width: calc(50% - 20px); height: calc(50% - 20px); }
  #main > div > textarea { width: 100%; height: 100%; }
</style>

<div id="top">
  <div style="overflow: auto; margin-bottom: 5px;">
    <div>
      <div style="float: left;">
        <button id="go" style="font-weight: bold;">Process query in Drew</button>
      </div>
      <div style="float: left; border: 1px solid black; margin-left: 5px; padding: 0 5px;">
        Language:
        <input type="radio" name="language" value="txt"> plain text
        <input type="radio" name="language" value="js" checked> JavaScript
        <input type="radio" name="language" value="css"> CSS
      </div>
      <div style="float: left; border: 1px solid black; margin-left: 5px; margin-bottom: 2px; padding: 0 5px;">
        Repeat mode:
        <input type="radio" name="repeatMode" value="once"> once
        <input type="radio" name="repeatMode" value="after" checked> after
        <input type="radio" name="repeatMode" value="every"> every
      </div>
      <div style="float: left; border: 1px solid black; margin-left: 5px; padding: 0 5px;">Input copy mode:
        <input type="radio" name="copyInputMode" value="nocopy" checked> nocopy
        <input type="radio" name="copyInputMode" value="copy"> copy
      </div>
    </div>
    <div style="float: left; border: 1px solid black; margin-left: 5px; padding: 0 5px;">
      Verbosity:
      <input type="radio" name="verbosity" value="verbose"> verbose
      <input type="radio" name="verbosity" value="throttle" checked> limited
      <input type="radio" name="verbosity" value="silent"> silent
    </div>
  </div>
  <div style="margin-bottom: 5px;">
    Examples:
    <select id="toload">
    </select>
    <button id="load">load</button>
    <button id="save">save</button>
    <button id="delete">delete</button>
    <button id="reset">remove localStorage</button>
    <button id="pi" title="see console">&pi;</button>
  </div>
  <div>Query:
    <button id="parse">parse</button>
    <input id="query" style="width: calc(100% - 150px);"
     value="{`if` | `while`} {PAREN_PAIR}=,0 (~ [NEWLINE])=2,3 {`{`}=,1"
    >
  </div>
</div>
<div id="main">
  <div style="margin-right: 10px; margin-bottom: 20px;">
    <div>Debug. Title: <input id="desc" style="width: calc(100% - 90px);"></div>
    <textarea id="debug">
This is the debug output area. Write to document.getElementById('debug').value to change it.
To the right is the handler which is evalled and called whenever the query triggers a callback.
Below is the input string, in this demo it ought to be valid JavaScript.
Below-right will be the result after applying the rule above to the input below with the callback to the right.
When you first load this page it should contain an example. Just press the "process" button in the top-left.
    </textarea>
  </div>
  <div style="margin-bottom: 20px; position: relative;">
    Handler: function( <input id="args" value="parenStop, curlyOpen, whiteStart, whiteStop" style="width: calc(100% - 150px);"> ){
    <textarea id="handler">
document.querySelector('#debug').value += 'callback called with '+arguments.length+' arguments\n\n';

parenStop.value += ' {';
curlyOpen.value = '';
whiteStart.value = '';
whiteStop.value = '';
    </textarea>
  </div>
  <div style="margin-right: 10px;">
    <div>Input code</div>
    <textarea id="input">
if (foo)
{
  bar;
}

while (have)
{
  weird()
}
    </textarea>
  </div>
  <div>
    <div>Output code</div>
    <textarea id="output"></textarea>
  </div>
</div>
<div style="text-align: center;">
  Drew, "The Declarative Rewriting Expression Wengine", is made by Peter van der Zee, &copy; 2015, <a href="http://qfox.nl/">qfox.nl</a>. Code and <a href="http://github.com/qfox/drew/README.md">docs</a> on Github: <a href="http://github.com/qfox/drew">github.com/qfox/drew</a>
</div>

<script>
  document.querySelector('#parse').onclick = function () {
    var rule = document.querySelector('#query').value;
    var funcCode = parse(rule, constants, macros);
    document.querySelector('#debug').value = funcCode;
  };
  document.querySelector('#go').onclick = function () {

    document.querySelector('#debug').value = '';
    var rule = document.querySelector('#query').value;
    var language = document.querySelector('[name="language"]:checked').value;
    var repeatMode = document.querySelector('[name="repeatMode"]:checked').value;
    var copyInputMode = document.querySelector('[name="copyInputMode"]:checked').value;
    VERBOSE = document.querySelector('[name="verbosity"]:checked').value !== 'silent'; // also resets dead mans switch
    VERBOSEMAX = document.querySelector('[name="verbosity"]:checked').value === 'throttle' ? 5000 : Infinity;

    var input = document.querySelector('#input').value;
    var handler = Function.apply(Function, document.querySelector('#args').value.split(',').concat([document.querySelector('#handler').value]));

    LOG('Target query:', [rule]);
    LOG('Target input:', [input]);
    LOG(handler);

    var funcCode = parse(rule, constants, macros);
    switch (language) {
      case 'txt':
        document.querySelector('#debug').value += 'Tokenized input as plain text (one character per token)\n\n';
        window.TOKENS = split(input);
        break;

      case 'js':
        document.querySelector('#debug').value += 'Tokenized input as JavaScript (as per ZeParser2)\n\n';
        window.TOKENS = Par.parse(input, {saveTokens: true}).whites;
        break;

      case 'css':
        throw 'tbd';
    }

    LOG(funcCode);
    LOG('tokens:', TOKENS);

    run(TOKENS, funcCode, handler, repeatMode, copyInputMode);

    document.querySelector('#output').value = TOKENS.map(function (t) {
      return t.value;
    }).join('');
  };

  function fillDropdown(selected) {
    try {
      var x = JSON.parse(localStorage.getItem('Drew-examples'));
      if (x) consoleExamples = x;
    } catch(e){}


    var select = document.querySelector('#toload');
    while (select.children.length) select.remove(0);
    consoleExamples.forEach(function(o, i){
      var option = document.createElement('option');
      option.value = i+'';
      option.innerHTML = o.desc;
      if (o.desc === selected) option.selected = true;
      select.appendChild(option);
    });
  }

  fillDropdown();

  document.querySelector('#load').onclick = function () {
    var select = document.querySelector('#toload');
    var d = consoleExamples[select.selectedIndex];
    if (d.desc === 'clear') {
      document.querySelector('#desc').value = 'untitled';
      document.querySelector('#query').value = '';
      document.querySelector('[value="once"]').checked = false;
      document.querySelector('[value="after"]').checked = false;
      document.querySelector('[value="every"]').checked = true;
      document.querySelector('[value="nocopy"]').checked = true;
      document.querySelector('[value="copy"]').checked = false;
      document.querySelector('#input').value = '';
      document.querySelector('#args').value = '';
      document.querySelector('#handler').value = '';
      document.querySelector('#output').value = '';
      document.querySelector('#debug').value = '';
    } else {
      document.querySelector('#desc').value = d.desc;
      document.querySelector('#query').value = d.query;
      document.querySelector('[value="txt"]').checked = d.language === 'txt';
      document.querySelector('[value="js"]').checked = d.language === 'js';
      document.querySelector('[value="css"]').checked = d.language === 'css';
      document.querySelector('[value="once"]').checked = d.repeat === 'once';
      document.querySelector('[value="after"]').checked = d.repeat === 'after';
      document.querySelector('[value="every"]').checked = d.repeat === 'every';
      document.querySelector('[value="nocopy"]').checked = d.copy === 'nocopy';
      document.querySelector('[value="copy"]').checked = d.copy === 'copy';
      document.querySelector('#input').value = d.input;
      document.querySelector('#args').value = d.handlerargs;
      document.querySelector('#handler').value = d.handler;
      document.querySelector('#output').value = '';
      document.querySelector('#debug').value = '';
    }
  };

  function populate(obj) {
    obj.desc = document.querySelector('#desc').value || 'untitled';
    obj.query = document.querySelector('#query').value;
    obj.input = document.querySelector('#input').value;
    obj.handlerargs = document.querySelector('#args').value;
    obj.handler = document.querySelector('#handler').value;
    obj.repeat = document.querySelector('[name="repeatMode"]:checked').value;
    obj.copy = document.querySelector('[name="copyInputMode"]:checked').value;
    obj.language = document.querySelector('[name="language"]:checked').value;

    return obj;
  }

  document.querySelector('#save').onclick = function(){
    var desc = document.querySelector('#desc').value;
    if (!desc) desc = 'untitled';
    var obj;
    for (var i=0; i<consoleExamples.length; ++i) if (consoleExamples[i].desc === desc) obj = consoleExamples[i];
    if (!obj) consoleExamples.push(obj = {});

    populate(obj);

    localStorage.setItem('Drew-examples', JSON.stringify(consoleExamples));

    fillDropdown(desc);
  };

  document.querySelector('#delete').onclick = function(){
    var select = document.querySelector('#toload');
    var d = consoleExamples[select.selectedIndex];
    if (d.desc !== 'clear') {
      if (confirm('Are you sure you want to delete this item?\nThis is permanent!\ntitle = `'+d.desc+'`')) {
        for (var i=0; i<consoleExamples.length; ++i) {
          if (consoleExamples[i] === d) {
            console.log('remove')
            consoleExamples.splice(i, 1);
            select.remove(i);
            break;
          }
        }
      }
    }

    localStorage.setItem('Drew-examples', JSON.stringify(consoleExamples));
  };

  document.querySelector('#reset').onclick = function() {
    localStorage.removeItem('Drew-examples');
  };

  document.querySelector('#pi').onclick = function() {
    console.log(JSON.stringify(populate({})));
  };
</script>
